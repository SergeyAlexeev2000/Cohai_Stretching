# План переработки backend (plan_backend_refactor.md)

Цель: привести наш FastAPI + SQLite backend к реальной модели данных Cohai Stretching, синхронизировать с существующим приложением (насколько возможно) и подготовить базу для будущего сайта.

## 1. Аудит текущей структуры

1.1. Зафиксировать текущее состояние
- Экспортировать схему БД (`.db`) в текст (`.sql`) для истории.
- Описать существующие таблицы: `locations`, `program_types`, `memberships`, `class_sessions`, `trainers`, `leads` (если есть).

1.2. Сопоставить с реальными сущностями из приложения и инсты
- Клиент (user).
- Клиентский тип: взрослый / ребёнок.
- Пол: м/ж/-.
- Возраст / дата рождения.
- Типы занятий (форматы).
- Правила абонементов (срок действия, заморозка, списание при неявке и т.п.).
- Прайсы (форматы, количество тренировок, наличие коврика, пробные занятия).
- Локации (студия, парк и т.п.).

1.3. Решить, что backend делает сейчас и в ближайшие 2–3 месяца
- Принимает заявки с сайта (лиды).
- Отдаёт публичные данные:
  - список локаций;
  - типы занятий / абонементы;
  - расписание.
- Ведёт простую CRM для Анастасии (возможный следующий этап).

---

## 2. Новая схема БД (черновик)

2.1. Сущности «контента» (для сайта и приложения)
- `locations` — студии/локации.
- `program_types` — направления/форматы тренировок (активный, классический, female styles, спина, дети, мужчины, парки и т.п.).
- `memberships` — абонементы и пакеты:
  - тип (группа/персональная/дуо/трио/парк);
  - количество занятий;
  - срок действия;
  - цена;
  - наличие коврика (да/нет/аренда);
  - пометка «пробное» / «гостевой пакет».

- `class_sessions` — конкретные занятия в расписании:
  - дата, время начала/конца;
  - локация;
  - `program_type_id`;
  - тренер;
  - вместимость;
  - язык (RU/RO/оба).

- `trainers` — тренеры и их данные.

2.2. Сущности «пользователей и заявок»
- `leads` — заявки с сайта:
  - имя, телефон, предпочтительный формат, комментарий, источник (сайт/лендинг).
- `clients` (позже) — реальные клиенты студии.
- `client_memberships` (позже) — выданные абонементы.

2.3. Сущности «контента» второго уровня
- `cases` — истории/кейсы (например, беременность).
- `testimonials` — отзывы.
- `loyalty_programs` — конфигурация текущей программы лояльности (1 друг → 2 тренировки и т.п.).

---

## 3. Пошаговый план миграций

> Пока нет Alembic, но планируем перейти на него. Шаги ниже — логика, а не конкретные команды.

### Шаг 3.1. Включить Alembic

3.1.1. Установить Alembic и настроить
- Добавить в `requirements.txt`.
- Сгенерировать директорию `alembic`.
- Настроить `alembic.ini` на работу с `cohai_stretching.db` и ORM‑моделями.

3.1.2. Создать первую «baseline»‑миграцию
- Считать текущую схему из моделей.
- Зафиксировать как начальное состояние (revision 0001).

---

### Шаг 3.2. Перечистить и доопределить модели

3.2.1. `Location`
- Проверить поля: `id`, `name`, `address`, `city`, `lat`, `lng`, `is_active`.
- Добавить `created_at`, `updated_at` (если ещё нет).

3.2.2. `ProgramType`
- Привести названия к реальным форматам из расписания и прайса.
- Добавить поля:
  - `slug` (например: `active_stretch`, `classic_stretch`, `back_all_inclusive`);
  - `description_short`, `description_full`;
  - `is_group`, `is_personal`, `is_park`, `is_kids`, `is_men`, `is_female_styles` (флаги по необходимости).

3.2.3. `Membership`
- Переписать модель исходя из прайса:
  - `program_type_id` (nullable для «общих» абонементов);
  - `name` (например: «4 групповых в месяц»);
  - `sessions_count` (4/8/12/1 и т.п.);
  - `price`;
  - `duration_days` (30/40 и т.д.);
  - `is_trial` (пробное);
  - `is_guest_special` (спеццена для гостей);
  - `location_id` (если прайс привязан к конкретной студии);
  - `notes` (текстовое пояснение).

3.2.4. `ClassSession`
- Проверить структуру:
  - `start_time`, `end_time` или `start_datetime` + `duration_minutes`;
  - ссылки на `location`, `program_type`, `trainer`;
  - `capacity`, `is_cancelled`, `language`.

3.2.5. `Trainer`
- Поля: `first_name`, `last_name`, `bio`, `photo_url`, `languages`, `sport_background`, `experience_years`.

3.2.6. `Lead`
- Убедиться, что есть таблица (если нет — создать):
  - `name`, `phone`, `preferred_program_type_id`, `message`, `source`, `created_at`, `status`.

3.2.7. Создать ревизию Alembic с изменениями моделей
- `alembic revision --autogenerate -m "Refine schemas to match real business"`
- Проверить скрипт миграции руками.
- Прогнать миграции на dev‑БД.

---

### Шаг 3.3. Заполнить справочники начальными данными

3.3.1. Скрипт `bootstrap_db.py`
- Создать стандартный набор `locations` (Testemițanu 3/13).
- Заполнить `program_types` (из расписания и прайса).
- Заполнить `memberships` (на основе прайса).

3.3.2. Хранить bootstrap‑данные в структуре Python (словарь/список) или в `.json` файле.

3.3.3. Добавить команду в README:
- `python -m app.tools.bootstrap_db` для первичного заполнения.

---

## 4. API слои и паблик‑эндпоинты

### 4.1. Публичные эндпоинты (для сайта)

4.1.1. `GET /public/locations`
- Выдаёт активные локации: id, имя, адрес, координаты.

4.1.2. `GET /public/program-types`
- Список направлений, с флагами по типу.

4.1.3. `GET /public/memberships`
- Список доступных пакетов с фильтрами:
  - `type` (group/personal/park),
  - `location_id`,
  - `is_trial`,
  - `is_guest_special`.

4.1.4. `GET /public/schedule`
- Параметры:
  - `location_id`, `date_from`, `date_to`, `program_type_id`.
- Возвращает список занятий со временем, типом, тренером, вместимостью.

4.1.5. `POST /public/leads`
- Принимает заявку с сайта:
  - имя, телефон, желаемый формат, комментарий.
- Создаёт запись в `Lead` + возвращает статус `accepted`.

---

### 4.2. Внутренние / будущие эндпоинты

4.2.1. Управление расписанием
- CRUD для `class_sessions` (для админки в будущем).

4.2.2. Управление прайсом
- CRUD для `memberships`.

4.2.3. Управление контентом (кейсы, отзывы)
- CRUD для `cases`, `testimonials` (на второй фазе).

---

## 5. Тесты и стабильность

5.1. Покрыть тестами public‑эндпоинт `/public/memberships` и `/public/schedule`
- Тесты уже начаты (`tests/test_public_memberships.py`) — расширить.

5.2. Добавить тесты для `POST /public/leads`
- Проверить валидацию телефона и обязательных полей.

5.3. Добавить smoke‑тесты для `bootstrap_db.py`
- Проверить, что скрипт можно запускать многократно, и он не дублирует данные.

---

## 6. Этапность работ по backend

### Этап 1
- Настроить Alembic, сделать baseline.
- Легко доработать модели без ломких изменений.
- Реализовать `POST /public/leads` и убедиться, что из фронта можно отправлять заявки.

### Этап 2
- Полностью привести `program_types`, `memberships`, `class_sessions` к реальной структуре.
- Заполнить справочники из прайса и расписания.
- Расширить публичные эндпоинты.

### Этап 3
- Добавить сущности «клиент», «выданный абонемент» (если Анастасия захочет вести CRM в нашей системе).
- Подготовиться к возможной интеграции с существующим мобильным приложением.
